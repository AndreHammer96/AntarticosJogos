<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SCOUTS ANTARTICOS</title>
  <h1 class="page-title">‚öΩ DOSSI√ä DOS P√â DE RATO QUE NAO V√ÉO JOGAR ‚öΩ</h1>

  <!-- √çcones -->
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/logo_v2.png') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='img/logo_v2.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/logo_v2.png') }}">
  <link rel="icon" href="{{ url_for('static', filename='img/logo_v2.png') }}" type="image/png">

  <style>
	:root{
	  --bg:#f7f8fa;
	  --card:#fff;
	  --muted:#6b7280;
	  --accent:#10b981;
	  --border:#e6e9ed;
	}

	body{
	  font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
	  background:var(--bg);
	  margin:0;
	  padding:20px;
	  color:#111;
	}

	.wrap{max-width:none;margin:0 auto}

	.card{
	  background:var(--card);
	  border-radius:12px;
	  box-shadow:0 8px 20px rgba(20,30,40,0.06);
	  padding:10px;
	  border:2px solid var(--border);
	  margin-bottom:50px;
	}

	.page-title{
	  text-align:center;
	  margin:0 auto 24px;
	  color:#1f2937;
	  font-size:3rem;
	  font-weight:1000;
	}

	/* ================= GRID PRINCIPAL ================= */
	/* Jogador | Jogos | F | T | % */
	.players-header,
	.row{
	  display:grid;
	  grid-template-columns: 
		minmax(200px, 1fr)
		70px
		70px
		70px
		80px;
	  align-items:center;
	  column-gap:16px;
	}

	/* ================= HEADER ================= */
	.players-header{
	  padding:12px 8px;
	  border-bottom:2px solid var(--border);
	  background:#f8f9fa;
	  border-radius:8px 8px 0 0;
	}

	.players-header .sortable{
	  cursor:pointer;
	  user-select:none;
	  padding:8px 4px;
	  border-radius:6px;
	  transition:background-color .2s;
	}

	.players-header .sortable:hover{background:#e9ecef}

	.sortable::after{
	  content:"‚Üï";
	  margin-left:6px;
	  font-size:12px;
	  opacity:.6;
	}

	.sortable.asc::after{content:"‚Üë";color:var(--accent);opacity:1}
	.sortable.desc::after{content:"‚Üì";color:var(--accent);opacity:1}

	/* ================= LISTA ================= */
	.list{
	  border:1px solid var(--border);
	  border-top:none;
	  border-radius:0 0 8px 8px;
	}

	.row{
	  padding:14px 8px;
	  border-bottom:1px solid var(--border);
	  transition:background-color .2s;
	}

	.row:hover{background:#f8f9fa}

	.row .name{font-weight:600}

	.row .qtd,
	.row .pct{
	  text-align:center;
	  font-weight:600;
	}

	.row .pct{
	  color:var(--muted);
	  font-size:14px;
	}

	/* ================= BOT√ÉO ================= */
	.expand-all-btn{
	  width:100%;
	  padding:12px;
	  margin-top:16px;
	  background:#f8f9fa;
	  border:1px solid var(--border);
	  border-radius:8px;
	  cursor:pointer;
	  font-weight:600;
	}

	.expand-all-btn:hover{background:#e9ecef}

	/* ================= TABELA COMPLETA ================= */
	.full-table{
	  display:none;
	  margin-top:16px;
	  overflow:auto;
	  max-height:70vh;
	  border:1px solid var(--border);
	  border-radius:8px;
	}

	.full-table table{
	  width:100%;
	  border-collapse:collapse;
	  min-width:600px;
	}

	.full-table th,
	.full-table td{
	  padding:12px 8px;
	  text-align:center;
	  border:1px solid var(--border);
	  font-size:13px;
	}

	.full-table th{
	  background:#f8f9fa;
	  font-weight:600;
	  position:sticky;
	  top:0;
	  z-index:10;
	}

	.full-table .player-name{
	  text-align:left;
	  font-weight:600;
	  background:#f8f9fa;
	  position:sticky;
	  left:0;
	  z-index:5;
	  min-width:150px;
	}

	.full-table td.present{
	  background:#d1fae5;
	  color:#065f46;
	}

	.full-table td.absent{
	  background:#fee2e2;
	  color:#991b1b;
	}
	/* ===== INPUTS DE DATA (RESTORE VISUAL ORIGINAL) ===== */
	.period-selector input[type="date"]{
	  padding:8px 12px;
	  border-radius:8px;
	  border:1px solid var(--border);
	  background:#ffffff;
	  font-weight:600;
	  font-size:14px;
	  color:#111;
	}

	.period-selector button{
	  padding:8px 18px;
	  border-radius:8px;
	  background:var(--accent);
	  color:#fff;
	  border:none;
	  font-weight:700;
	  cursor:pointer;
	}

	.period-selector button:hover{
	  opacity:0.9;
	}
	
	.trofeu-icon{
	  width:20px;
	  height:20px;
	  object-fit:contain;
	  vertical-align:middle;
	}
	#adminFab{
	  position: fixed;
	  bottom: 24px;
	  right: 24px;
	  width: 60px;
	  height: 60px;
	  border-radius: 50%;
	  background: #10b981;
	  color: #fff;
	  font-size: 32px;
	  border: none;
	  cursor: pointer;
	  box-shadow: 0 10px 20px rgba(0,0,0,.2);
	  z-index: 999;
	}
	/* ===== ADMIN PANEL ===== */
	#adminPanel{
	  position: fixed;
	  bottom: 100px;
	  right: 24px;
	  width: 320px;
	  background: #fff;
	  border: 2px solid var(--border);
	  border-radius: 12px;
	  box-shadow: 0 20px 40px rgba(0,0,0,.2);
	  padding: 16px;
	  z-index: 1000;
	}

	#adminPanel.hidden{
	  display: none;
	}

	#adminPanel h2{
	  margin-top: 0;
	  font-size: 18px;
	}

	#playerSearch{
	  width: 100%;
	  padding: 8px;
	  margin-bottom: 8px;
	}

	#autocompleteList{
	  border: 1px solid var(--border);
	  border-radius: 6px;
	  max-height: 120px;
	  overflow-y: auto;
	  margin-bottom: 8px;
	}

	.autocomplete-item{
	  padding: 6px 10px;
	  cursor: pointer;
	}

	.autocomplete-item:hover{
	  background: #f3f4f6;
	}

	#selectedPlayers{
	  display: flex;
	  flex-wrap: wrap;
	  gap: 6px;
	  margin-bottom: 12px;
	}

	.player-pill{
	  background: #e5e7eb;
	  border-radius: 20px;
	  padding: 6px 10px;
	  font-size: 13px;
	  display: flex;
	  align-items: center;
	  gap: 6px;
	}

	.player-pill span{
	  cursor: pointer;
	  font-weight: bold;
	}

</style>


</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="period">
      <div class="range" id="periodRange"></div>
      <div class="period-selector">
        <input type="date" id="startDate" value="2025-01-01">
        <span>at√©</span>
        <input type="date" id="endDate" value="2025-12-31">
        <button id="applyPeriod">Aplicar</button>
      </div>
    </div>

    <div class="filters" style="margin-bottom:10px; display:flex; align-items:center; gap:10px;">
      <input type="checkbox" id="showGuests" checked>
      <label for="showGuests">Mostrar convidados</label>
    </div>

    <div class="main-content">
      <div class="players-header">
        <div class="player-name-sort sortable" id="sortByName">Jogador</div>
        <div class="player-qtd-sort sortable" id="sortByQtd">Jogos</div>
		<div class="player-qtd-sort sortable" id="sortByF">
		  <img src="{{ url_for('static', filename='img/feijoada.png') }}"
			   class="trofeu-icon"
			   alt="Feijoada">
		</div>
		<div class="player-qtd-sort sortable" id="sortByT">
		  <img src="{{ url_for('static', filename='img/thy.png') }}"
			   class="trofeu-icon"
			   alt="ThyOliveira">
		</div>

        <div class="player-pct-sort sortable" id="sortByPct">%</div>
      </div>
      <div class="list" id="playersList"></div>
    </div>

    <button class="expand-all-btn" id="expandAllBtn">üìä VER TABELA COMPLETA</button>
    <div class="full-table" id="fullTable">
      <table>
        <thead id="fullTableHeader"></thead>
        <tbody id="fullTableBody"></tbody>
      </table>
    </div>
  </div>
</div>
	<button id="adminFab">+</button>
	<div id="adminPanel" class="hidden">
	  <h2>Novo Jogo</h2>

	  
	  <label>Data do jogo</label>
		<div style="display:flex; gap:8px; align-items:center;">
		  <input type="date" id="gameDate">
		  <button id="loadGame">Atualizar</button>
		</div>
	  <input type="text" id="playerSearch" placeholder="Digite o nome">
		<div id="autocompleteList"></div>

	  <div id="selectedPlayers"></div>
		<label>üèÜ Feijoada</label>
		<select id="trofeuF">
		  <option value="">‚Äî selecionar ‚Äî</option>
		</select>
		<br>
		<label>üí© Thy Oliveira</label>
		<select id="trofeuT">
		  <option value="">‚Äî selecionar ‚Äî</option>
		</select>
	  <button id="saveGame">Salvar</button>
	</div>

	<hr>

	


<script>
let jogadoresFlask = {{ jogadores | tojson | safe }};
let games = {{ col_datas | tojson | safe }};
let filteredGames = [...games];

let currentSort = { field: 'name', direction: 'asc' };
document.getElementById("periodRange").textContent =
  `Jogos no per√≠odo: ${filteredGames.length}`;

function updateSortIndicators(){
  const map = {
    name: 'sortByName',
    qtd: 'sortByQtd',
    pct: 'sortByPct',
    f:   'sortByF',
    t:   'sortByT'
  };

  Object.values(map).forEach(id=>{
    const el = document.getElementById(id);
    el.classList.remove('asc','desc');
  });

  const active = document.getElementById(map[currentSort.field]);
  if (active) active.classList.add(currentSort.direction);
}

function sortPlayers(field){
  if(currentSort.field === field){
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.field = field;
    currentSort.direction = 'asc';
  }

  jogadoresFlask.sort((a,b)=>{
    let A, B;

    if(field === 'name'){
      A = a.nome.toLowerCase();
      B = b.nome.toLowerCase();
      return currentSort.direction === 'asc'
        ? A.localeCompare(B)
        : B.localeCompare(A);
    }

    if(field === 'qtd'){
	  A = calcularJogosPeriodo(a);
	  B = calcularJogosPeriodo(b);
	}


    if(field === 'pct'){
	  A = filteredGames.length ? calcularJogosPeriodo(a) / filteredGames.length : 0;
	  B = filteredGames.length ? calcularJogosPeriodo(b) / filteredGames.length : 0;
	}

	
	if(field === 'f'){
	  A = calcularTrofeuFPeriodo(a);
	  B = calcularTrofeuFPeriodo(b);
	}


	if(field === 't'){
	  A = calcularTrofeuTPeriodo(a);
	  B = calcularTrofeuTPeriodo(b);
	}



    return currentSort.direction === 'asc' ? A - B : B - A;
  });

  updateSortIndicators();
  renderList();
  if (document.getElementById('fullTable').style.display === 'block') {
    renderFullTable();
  }
}
function calcularJogosPeriodo(jogador){
  let total = 0;

  for (const d of filteredGames){
    const info = jogador.jogos[d];
    if (info && info.jogou === true){
      total++;
    }
  }

  return total;
}
function calcularTrofeuFPeriodo(jogador){
  let total = 0;

  for (const d of filteredGames){
    const info = jogador.jogos[d];
    if (info && info.jogou === true && info.flag === 'F'){
      total++;
    }
  }

  return total;
}

function calcularTrofeuTPeriodo(jogador){
  let total = 0;

  for (const d of filteredGames){
    const info = jogador.jogos[d];
    if (info && info.jogou === true && info.flag === 'T'){
      total++;
    }
  }

  return total;
}

function renderList(){
  const container = document.getElementById('playersList');
  container.innerHTML='';

  jogadoresFlask.forEach(j=>{
    const jogosPeriodo   = calcularJogosPeriodo(j);
    const trofeuFPeriodo = calcularTrofeuFPeriodo(j);
    const trofeuTPeriodo = calcularTrofeuTPeriodo(j);

    const row=document.createElement('div');
    row.className='row';
    row.innerHTML=`
      <div class="name">${j.tipo === "time" ? 'üêß ' : ''}${j.nome}</div>
      <div class="qtd">${jogosPeriodo}</div>
      <div class="qtd">${trofeuFPeriodo}</div>
      <div class="qtd">${trofeuTPeriodo}</div>
      <div class="pct">
        ${filteredGames.length
          ? ((jogosPeriodo / filteredGames.length) * 100).toFixed(1)
          : '0.0'}%
      </div>
    `;
    container.appendChild(row);
  });
}


document.getElementById("applyPeriod").addEventListener("click", () => {
  const start = document.getElementById("startDate").value;
  const end   = document.getElementById("endDate").value;

  if (!start || !end) {
    alert("Selecione as duas datas!");
    return;
  }

  // dd/mm/yyyy ‚Üí Date
  function parseDateBR(d){
    const [dd,mm,yy] = d.split("/");
    return new Date(`${yy}-${mm}-${dd}`);
  }

  const startDate = new Date(start); // yyyy-mm-dd
  const endDate   = new Date(end);

  filteredGames = games.filter(d => {
    const dt = parseDateBR(d);
    return dt >= startDate && dt <= endDate;
  });

  // atualiza contador
  document.getElementById("periodRange").textContent =
    `Jogos no per√≠odo: ${filteredGames.length}`;

  renderList();

  if (document.getElementById("fullTable").style.display === "block") {
    renderFullTable();
  }
});

document.getElementById('sortByName').onclick = ()=>sortPlayers('name');
document.getElementById('sortByQtd').onclick  = ()=>sortPlayers('qtd');
document.getElementById('sortByF').onclick = ()=>sortPlayers('f');
document.getElementById('sortByT').onclick = ()=>sortPlayers('t');
document.getElementById('sortByPct').onclick  = ()=>sortPlayers('pct');

function renderFullTable(){
  const header = document.getElementById('fullTableHeader');
  const body   = document.getElementById('fullTableBody');

  header.innerHTML =
    '<tr><th class="player-name">Jogador</th>' +
    filteredGames.map(d => `<th>${d}</th>`).join('') +
    '</tr>';

  body.innerHTML = '';

  jogadoresFlask.forEach(j => {
    let row = `
      <tr>
        <td class="player-name">
          ${j.tipo === "time" ? 'üêß ' : ''}${j.nome}
        </td>
    `;

    for (const d of filteredGames) {
      const info = j.jogos[d];   // üëà OBJETO

      let classe  = 'absent';
      let simbolo = '‚úó';

      if (info && info.jogou === true) {
        classe = 'present';
        simbolo = '‚úì';

		if (info.flag === 'F') {
		  simbolo = `<img src="/static/img/feijoada.png" class="trofeu-icon" alt="Feijoada">`;
		}
        if (info.flag === 'T') {
		  simbolo = `<img src="/static/img/thy.png" class="trofeu-icon" alt="ThyOliveira">`;
		}
      }

      row += `<td class="${classe}">${simbolo}</td>`;
    }

    row += '</tr>';
    body.innerHTML += row;
  });
}

function atualizarSelectsTrofeu(){
  const selectF = document.getElementById("trofeuF");
  const selectT = document.getElementById("trofeuT");

  selectF.innerHTML = '<option value="">‚Äî selecionar ‚Äî</option>';
  selectT.innerHTML = '<option value="">‚Äî selecionar ‚Äî</option>';

  selectedPlayers.forEach(nome => {
    selectF.innerHTML += `<option value="${nome}">${nome}</option>`;
    selectT.innerHTML += `<option value="${nome}">${nome}</option>`;
  });
}


// ===== BOT√ÉO VER TABELA COMPLETA =====
document.getElementById('expandAllBtn').addEventListener('click', () => {
  const table = document.getElementById('fullTable');
  const isVisible = table.style.display === 'block';

  table.style.display = isVisible ? 'none' : 'block';

  if (!isVisible) {
    renderFullTable();
  }
});


document.addEventListener('DOMContentLoaded',()=>{
  renderList();
  updateSortIndicators()
});
/* ================= ADMIN PANEL LOGIC ================= */

const adminFab = document.getElementById("adminFab");
const adminPanel = document.getElementById("adminPanel");
const playerSearch = document.getElementById("playerSearch");
const autocompleteList = document.getElementById("autocompleteList");
const selectedPlayersBox = document.getElementById("selectedPlayers");
const saveGameBtn = document.getElementById("saveGame");
const loadGameBtn = document.getElementById("loadGame");

let selectedPlayers = [];

// abrir / fechar painel
adminFab.onclick = () => {
  adminPanel.classList.toggle("hidden");
};

// AUTOCOMPLETE
playerSearch.addEventListener("input", () => {
  const query = playerSearch.value.toLowerCase();
  autocompleteList.innerHTML = "";

  if (!query) return;

  jogadoresFlask
    .map(j => j.nome)
    .filter(n =>
      n.toLowerCase().includes(query) &&
      !selectedPlayers.includes(n)
    )
    .forEach(name => {
      const div = document.createElement("div");
      div.className = "autocomplete-item";
      div.textContent = name;
      div.onclick = () => addPlayer(name);
      autocompleteList.appendChild(div);
    });
});

function addPlayer(name){
  selectedPlayers.push(name);
  playerSearch.value = "";
  autocompleteList.innerHTML = "";
  renderSelectedPlayers();
}

function removePlayer(name){
  selectedPlayers = selectedPlayers.filter(n => n !== name);
  renderSelectedPlayers();
}

function renderSelectedPlayers(){
  selectedPlayersBox.innerHTML = "";
  selectedPlayers.forEach(name => {
    const pill = document.createElement("div");
    pill.className = "player-pill";
    pill.innerHTML = `
      ${name}
      <span onclick="removePlayer('${name}')">√ó</span>
    `;
    selectedPlayersBox.appendChild(pill);
  });
}

// ===== ATUALIZAR =====
loadGameBtn.onclick = async () => {
  const date = document.getElementById("gameDate").value;
  if (!date){
    alert("Informe a data do jogo");
    return;
  }

  selectedPlayers = [];
  renderSelectedPlayers();

  const resp = await fetch(`/api/jogo?data=${date}`);
  if (!resp.ok) return;

  const data = await resp.json();

  selectedPlayers = data.jogadores || [];
  renderSelectedPlayers();
  atualizarSelectsTrofeu();

  document.getElementById("trofeuF").value = data.feijoada || "";
  document.getElementById("trofeuT").value = data.thy || "";
};




document.getElementById("gameDate").addEventListener("change", async () => {
  const date = document.getElementById("gameDate").value;
  if (!date) return;

  const res = await fetch(`/api/jogo?data=${date}`);
  if (!res.ok) return;

  const data = await res.json();
  selectedPlayers = data.jogadores || [];
  renderSelectedPlayers();
});

function renderSelecionados() {
  selectedPlayersDiv.innerHTML = "";
  selecionados.forEach(nome => {
    const pill = document.createElement("span");
    pill.style.padding = "6px 10px";
    pill.style.margin = "4px";
    pill.style.borderRadius = "999px";
    pill.style.background = "#e5e7eb";
    pill.style.display = "inline-flex";
    pill.style.alignItems = "center";
    pill.innerHTML = `
      ${nome}
      <button style="margin-left:8px;border:none;background:none;cursor:pointer">‚úï</button>
    `;
    pill.querySelector("button").onclick = () => {
      selecionados.delete(nome);
      renderSelecionados();
    };
    selectedPlayersDiv.appendChild(pill);
  });
}
saveGameBtn.onclick = async () => {
  const date = document.getElementById("gameDate").value;
  const senha = prompt("Digite a senha de administrador");

  if (!date || !senha){
    alert("Data e senha obrigat√≥rias");
    return;
  }

  const trofeuF = document.getElementById("trofeuF").value;
  const trofeuT = document.getElementById("trofeuT").value;

  const resp = await fetch("/api/jogo", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      data: date,
      jogadores: selectedPlayers,
      feijoada: trofeuF,
      thy: trofeuT,
      senha: senha
    })
  });

  const resJson = await resp.json();

  if (!resp.ok){
    alert(resJson.erro === "senha" ? "Senha incorreta" : "Erro ao salvar");
    return;
  }

  alert("Jogo salvo com sucesso");
  location.reload();
};



</script>


</body>
</html>
